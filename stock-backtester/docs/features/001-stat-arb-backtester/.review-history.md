# Review History: 001-stat-arb-backtester

## Stage 2: Chain Review - 2026-02-07T00:00:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved (0 blockers, 3 warnings, 2 suggestions)

**Warnings:**
- [warning] Phase 5 engine pipeline gross_returns variable naming ambiguous — unclear which intermediate value becomes BacktestResult.gross_returns (at: Phase 5, Step 4)
- [warning] Simulate CLI command pipeline redundancy with run_monte_carlo()'s internal historical backtest not documented (at: Phase 10, simulate command)
- [warning] AC-1b provenance not explicitly noted as spec-added criterion (at: AC Test Readiness Map)

**Suggestions:**
- Phase 8 simulation.py import topology (direct vs transitive dependencies) could be clarified for task breakdown
- Risk Mitigations table references "Design Section 9" without risk IDs

---

## Stage 1: Plan Review - Iteration 1 - 2026-02-07T00:00:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision (3 blockers, 7 warnings, 2 notes)

**Blockers:**
- [blocker] yfinance `multi_level_index=True` default (>= 0.2.51) breaks column normalization in Phase 3 (at: Phase 3 Step 2)
  Suggestion: Add `multi_level_index=False` to yf.download call
- [blocker] TDD ordering violated — implementation before tests in Phases 6-10 (at: Phases 6-10)
  Suggestion: Reorder all phases to RED-GREEN-REGRESSION pattern
- [blocker] Phase 8 dependency list `(types, data, engine, kelly)` inconsistent with AC Test Readiness Map showing AC-7 requires execution, strategy, metrics (at: Phase 8 header, AC Readiness Map)
  Suggestion: Correct to `(types, execution, strategy, data, engine, metrics, kelly)`

**Warnings:**
- [warning] `__main__.py` imports `from .cli import app` but cli.py doesn't exist until Phase 10 — ImportError during Phases 1-9 (at: Phase 0 Step 3)
- [warning] Missing ruin detection unit test in Phase 8 (at: Phase 8 Step 8)
- [warning] Cost approximation edge case: first trade has no prior weights, delta_w = full position (at: Phase 5)
- [warning] No rollback strategy if a phase's tests break prior phases (at: general)
- [warning] Phase 6 metrics tests lack specific known-answer values (at: Phase 6 Step 2)
- [warning] Phase 9 report tests don't verify survivorship warning text (at: Phase 9 Step 4)
- [warning] Phase 11 missing pyright validation task (at: Phase 11)

**Changes Made:**
- Fixed Blocker 1: Added `multi_level_index=False` to Phase 3's yf.download call
- Fixed Blocker 2: Rewrote Phases 2-10 with RED-GREEN-REGRESSION TDD pattern (tests first, implement to pass, run full suite)
- Fixed Blocker 3: Corrected Phase 8 dependency list to `(types, execution, strategy, data, engine, metrics, kelly)`
- Addressed warning: Phase 0 `__main__.py` now uses deferred import stub; replaced with real import in Phase 10
- Addressed warning: Added ruin detection unit tests to Phase 8 Step 2
- Addressed warning: Added cost approximation bound test to Phase 5 Step 2
- Addressed warning: Added "Regression" step after each phase to catch breakage
- Addressed warning: Added specific known-answer values to Phase 6 tests
- Addressed warning: Added survivorship warning check to Phase 9 tests
- Addressed warning: Added pyright validation task to Phase 11
- Bumped plan to v2

---

## Handoff Review - 2026-02-07T00:00:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved (0 blockers, 3 warnings, 2 suggestions)

**Warnings:**
- [warning] Implementation sequence (Section 10) does not estimate effort per step; plan phase must reconcile with PRD's 7-day timeline
- [warning] AC test dependencies on modules are implicit; plan phase should map each AC to its required module set
- [warning] pyright type checking is in design's pyproject.toml but not mentioned in spec; plan should include pyright validation task

**Suggestions:**
- Risk mitigations in Section 9 not linked to specific implementation steps; plan should map each
- PerfectForesightStrategy location (conftest.py vs strategy.py) should be explicit in task breakdown

---

## Design Review - Iteration 1 - 2026-02-07T00:00:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Approved (0 blockers, 6 warnings, 4 notes)

**Warnings:**
- [warning] [assumptions] yfinance >= 0.2.51 breaking changes to column structure; normalization defensive but version sensitivity needs implementation attention
  Challenge: Has column normalization been tested against yfinance >= 0.2.51?
- [warning] [consistency] Prior Art table: exceptions listed as "Adapt" but sibling centralizes exceptions (subterminator/utils/exceptions.py); our co-location is a "Depart"
  Challenge: Verified via Grep — sibling uses centralized exceptions, not co-located
- [warning] [consistency] half_kelly data flow into run_monte_carlo lacks explicit interface; function signature is (prices, strategy, config) with no half_kelly parameter
  Challenge: How does run_monte_carlo() obtain half_kelly?
- [warning] [completeness] Slippage dimensional analysis less rigorous than commission; k * sigma * |delta_w| product is dimensionless but confirmation needed
  Challenge: Confirm the product represents a fractional cost on the same scale as log-returns
- [warning] [completeness] warmup_end_idx inclusive/exclusive semantics could be clearer
  Challenge: Is equity_curve[warmup_end_idx] the start point (inclusive)?
- [warning] [feasibility] Python 3.12 requirement vs sibling project's 3.11; CI environment compatibility
  Challenge: Is 3.12 available in CI?

**Notes:**
- Prior Art table: sibling uses mypy, not pyright (row 5)
- Single-symbol degenerate case for simulate command not explicitly noted
- EqualWeight/AlwaysLong duplication is minor code smell
- Trailing vol NaN at bar 1 (< 2 observations) behavior unspecified

**Changes Made:**
- Corrected Prior Art table: exceptions changed from "Adapt" to "Depart"
- Corrected Prior Art table: type checker changed to "Depart: pyright instead of mypy"
- Added yfinance version sensitivity note in data.py design decisions
- Added half_kelly internal computation note in simulation.py design decisions
- Added dimensional analysis confirmation for slippage formula
- Clarified warmup_end_idx as inclusive positional index with example
- Added trailing vol NaN handling for early bars (treated as 0 slippage)

---


## Stage 1: Spec-Reviewer Review - Iteration 2 - 2026-02-07T00:00:00Z

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Approved (0 blockers, 7 warnings, 3 suggestions)

**Context:** Spec v3 → v4. Multi-symbol equal-weight rewrite. Two blockers from iteration 1 fixed.

**Previous Blockers Fixed:**
- Portfolio return formula corrected: simple returns for cross-sectional aggregation, log-returns for time-series (Jensen's inequality)
- AC-1b added: multi-symbol known-answer test catching aggregation bug

**Warnings:**
- [warning] [assumptions] yfinance returns capitalized column names (Open, Close); spec assumes lowercase
  Suggestion: Add df.columns.str.lower() normalization in fetch_prices
- [warning] [testability] warmup_end_idx is integer positional but equity_curve is DatetimeIndex-indexed
  Suggestion: Clarify iloc usage in BacktestResult docstring
- [warning] [clarity] Sharpe uses ddof=1 while Kelly uses ddof=0 — rationale undocumented
  Suggestion: Add rationale for each convention
- [warning] [testability] PerfectForesightStrategy interface unspecified
  Suggestion: Add test fixture specification
- [warning] [assumptions] BacktestConfig not passed to run_backtest — construction gap
  Suggestion: Add config parameter to run_backtest
- [warning] [clarity] Sharpe numerator (mean*252) differs from displayed Annualized Return (exp-1)
  Suggestion: Add clarifying note
- [warning] [assumptions] Synthetic simulation data bypasses data validation — implicit
  Suggestion: Add explicit note about schema conformance

**Changes Made:**
- Added column name normalization (df.columns.str.lower()) in data layer contract
- Clarified warmup_end_idx as positional index (iloc) in BacktestResult
- Added ddof rationale for both Sharpe (ddof=1, inferential) and Kelly (ddof=0, population)
- Added PerfectForesightStrategy specification in test fixtures
- Added config parameter to run_backtest signature
- Added Sharpe numerator vs Annualized Return clarifying note
- Added synthetic data schema conformance note in simulation

---

## Stage 2: Phase Review - Iteration 2 - 2026-02-07T00:00:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved (0 blockers, 5 warnings, 3 suggestions)

**Warnings:**
- [warning] Sortino full-count convention not explicitly named
  Suggestion: Add "(full-count convention per Sortino 2001)" parenthetical
- [warning] Sharpe numerator vs displayed Annualized Return confusion (overlap with spec-reviewer)
- [warning] PerfectForesightStrategy unspecified (overlap with spec-reviewer)
- [warning] half_kelly source in run_monte_carlo unclear
  Suggestion: Specify that half_kelly comes from historical backtest compute_kelly
- [warning] theoretical_ruin_rate source ambiguous (portfolio-level vs per-symbol calibration)
  Suggestion: Specify portfolio-level mu/sigma from historical net returns

**Changes Made:**
- Added Sortino 2001 full-count convention note
- Specified half_kelly source (historical backtest compute_kelly)
- Clarified theoretical_ruin_rate uses historical portfolio-level mu/sigma
- Added SimulationError class definition
- Specified GBM calibration ddof=1 (sample std)
- Added seed scope note (AC-6/AC-7 stochastic, others deterministic)

---

## Stage 1: Spec-Reviewer Review - Iteration 1 - 2026-02-07T00:00:00Z

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision (3 blockers, 8 warnings, 5 suggestions)

**Blockers:**
- [blocker] [assumptions] yfinance `auto_adjust=True` returns adjusted OHLC in 'Close' column, no separate 'Adj Close'. Spec assumed wrong column name.
  Suggestion: Use auto_adjust=True explicitly, remove Adj Close references.
- [blocker] [testability] ddof unspecified for Kelly estimator — pandas defaults to ddof=1 but test fixture assumes ddof=0. AC-4 would fail.
  Suggestion: Specify ddof=0 in both estimator and test.
- [blocker] [assumptions] Commission formula `commission_per_share * |delta_w| * close_price` has wrong units ($^2/share^2). Needs dimensional fix.
  Suggestion: Convert to fractional cost: commission_rate = commission_per_share / close_price.

**Warnings:**
- [warning] [traceability] Report format should enumerate exact fields for TABLE output.
- [warning] [testability] Net return formula units not clarified — slippage subtracted from log-returns needs unit consistency.
- [warning] [assumptions] Monte Carlo ruin detection scales returns but not costs — optimistic approximation.
- [warning] [clarity] SMA warmup_bars vs warmup_end_idx relationship unclear.
- [warning] [testability] AC-7 Sharpe computation method ambiguous (per-path vs ensemble).
- [warning] [scope] Module count says "seven" but lists nine.
- [warning] [assumptions] OHLCV adjustment status in data contract contradicts auto_adjust=True behavior.
- [warning] [clarity] Dependency graph shows report depending on metrics/kelly, but actual dependency is on types.py.

**Changes Made:**
- Fixed all 3 blockers: yfinance auto_adjust, ddof=0 convention, commission formula with dimensional analysis
- Fixed all 8 warnings: module count, dependency graph, report field enumeration, net return formula, MC leverage caveat, SMA warmup clarification, AC-7 method, OHLCV schema
- Addressed suggestions: NFR test file added, date range defaults, data/Kelly validation distinction, reproducibility metadata deferred
- Bumped spec to v2

---

## Stage 2: Phase Review - Iteration 1 - 2026-02-07T00:00:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved (0 blockers, 4 warnings, 2 suggestions)

**Warnings:**
- [warning] AlwaysLongStrategy warmup=0 interaction with shift(1) not explicit in AC-1
- [warning] Synthetic DataFrame construction for simulation paths not specified
- [warning] Annualized return convention (log vs geometric) ambiguous
- [warning] Equity curve formula not explicit

**Changes Made:**
- Added AlwaysLongStrategy warmup note to AC-1
- Added synthetic DataFrame spec to run_monte_carlo
- Clarified annualized return as geometric: exp(mean_log * 252) - 1
- Added equity curve formula: exp(cumsum(net_returns))

---
