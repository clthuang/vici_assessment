# Review History: 001-stat-arb-backtester (specify phase)

## Stage 1: Spec-Reviewer Review - Iteration 2 - 2026-02-07T00:00:00Z

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Approved (0 blockers, 7 warnings, 3 suggestions)

**Context:** Spec v3 → v4. Multi-symbol equal-weight rewrite. Two blockers from iteration 1 fixed.

**Previous Blockers Fixed:**
- Portfolio return formula corrected: simple returns for cross-sectional aggregation, log-returns for time-series (Jensen's inequality)
- AC-1b added: multi-symbol known-answer test catching aggregation bug

**Warnings:**
- [warning] [assumptions] yfinance returns capitalized column names (Open, Close); spec assumes lowercase
  Suggestion: Add df.columns.str.lower() normalization in fetch_prices
- [warning] [testability] warmup_end_idx is integer positional but equity_curve is DatetimeIndex-indexed
  Suggestion: Clarify iloc usage in BacktestResult docstring
- [warning] [clarity] Sharpe uses ddof=1 while Kelly uses ddof=0 — rationale undocumented
  Suggestion: Add rationale for each convention
- [warning] [testability] PerfectForesightStrategy interface unspecified
  Suggestion: Add test fixture specification
- [warning] [assumptions] BacktestConfig not passed to run_backtest — construction gap
  Suggestion: Add config parameter to run_backtest
- [warning] [clarity] Sharpe numerator (mean*252) differs from displayed Annualized Return (exp-1)
  Suggestion: Add clarifying note
- [warning] [assumptions] Synthetic simulation data bypasses data validation — implicit
  Suggestion: Add explicit note about schema conformance

**Changes Made:**
- Added column name normalization (df.columns.str.lower()) in data layer contract
- Clarified warmup_end_idx as positional index (iloc) in BacktestResult
- Added ddof rationale for both Sharpe (ddof=1, inferential) and Kelly (ddof=0, population)
- Added PerfectForesightStrategy specification in test fixtures
- Added config parameter to run_backtest signature
- Added Sharpe numerator vs Annualized Return clarifying note
- Added synthetic data schema conformance note in simulation

---

## Stage 2: Phase Review - Iteration 2 - 2026-02-07T00:00:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved (0 blockers, 5 warnings, 3 suggestions)

**Warnings:**
- [warning] Sortino full-count convention not explicitly named
  Suggestion: Add "(full-count convention per Sortino 2001)" parenthetical
- [warning] Sharpe numerator vs displayed Annualized Return confusion (overlap with spec-reviewer)
- [warning] PerfectForesightStrategy unspecified (overlap with spec-reviewer)
- [warning] half_kelly source in run_monte_carlo unclear
  Suggestion: Specify that half_kelly comes from historical backtest compute_kelly
- [warning] theoretical_ruin_rate source ambiguous (portfolio-level vs per-symbol calibration)
  Suggestion: Specify portfolio-level mu/sigma from historical net returns

**Changes Made:**
- Added Sortino 2001 full-count convention note
- Specified half_kelly source (historical backtest compute_kelly)
- Clarified theoretical_ruin_rate uses historical portfolio-level mu/sigma
- Added SimulationError class definition
- Specified GBM calibration ddof=1 (sample std)
- Added seed scope note (AC-6/AC-7 stochastic, others deterministic)

---

## Stage 1: Spec-Reviewer Review - Iteration 1 - 2026-02-07T00:00:00Z

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision (3 blockers, 8 warnings, 5 suggestions)

**Blockers:**
- [blocker] [assumptions] yfinance `auto_adjust=True` returns adjusted OHLC in 'Close' column, no separate 'Adj Close'. Spec assumed wrong column name.
  Suggestion: Use auto_adjust=True explicitly, remove Adj Close references.
- [blocker] [testability] ddof unspecified for Kelly estimator — pandas defaults to ddof=1 but test fixture assumes ddof=0. AC-4 would fail.
  Suggestion: Specify ddof=0 in both estimator and test.
- [blocker] [assumptions] Commission formula `commission_per_share * |delta_w| * close_price` has wrong units ($^2/share^2). Needs dimensional fix.
  Suggestion: Convert to fractional cost: commission_rate = commission_per_share / close_price.

**Warnings:**
- [warning] [traceability] Report format should enumerate exact fields for TABLE output.
- [warning] [testability] Net return formula units not clarified — slippage subtracted from log-returns needs unit consistency.
- [warning] [assumptions] Monte Carlo ruin detection scales returns but not costs — optimistic approximation.
- [warning] [clarity] SMA warmup_bars vs warmup_end_idx relationship unclear.
- [warning] [testability] AC-7 Sharpe computation method ambiguous (per-path vs ensemble).
- [warning] [scope] Module count says "seven" but lists nine.
- [warning] [assumptions] OHLCV adjustment status in data contract contradicts auto_adjust=True behavior.
- [warning] [clarity] Dependency graph shows report depending on metrics/kelly, but actual dependency is on types.py.

**Changes Made:**
- Fixed all 3 blockers: yfinance auto_adjust, ddof=0 convention, commission formula with dimensional analysis
- Fixed all 8 warnings: module count, dependency graph, report field enumeration, net return formula, MC leverage caveat, SMA warmup clarification, AC-7 method, OHLCV schema
- Addressed suggestions: NFR test file added, date range defaults, data/Kelly validation distinction, reproducibility metadata deferred
- Bumped spec to v2

---

## Stage 2: Phase Review - Iteration 1 - 2026-02-07T00:00:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved (0 blockers, 4 warnings, 2 suggestions)

**Warnings:**
- [warning] AlwaysLongStrategy warmup=0 interaction with shift(1) not explicit in AC-1
- [warning] Synthetic DataFrame construction for simulation paths not specified
- [warning] Annualized return convention (log vs geometric) ambiguous
- [warning] Equity curve formula not explicit

**Changes Made:**
- Added AlwaysLongStrategy warmup note to AC-1
- Added synthetic DataFrame spec to run_monte_carlo
- Clarified annualized return as geometric: exp(mean_log * 252) - 1
- Added equity curve formula: exp(cumsum(net_returns))

---
