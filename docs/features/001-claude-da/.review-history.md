# Review History: 001-claude-da

## Stage 1: Spec-Reviewer Review - Iteration 1 - 2026-02-07T13:00:00Z

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [feasibility] AC-02.9 claims Agent SDK has a timeout parameter, but ClaudeAgentOptions has no `timeout` field (at: REQ-02, AC-02.9)
  Suggestion: Use `asyncio.wait_for()` wrapper around the `query()` call with 240s timeout
- [blocker] [measurability] AC-04.7 references "3000 tokens" without specifying tokenizer — unmeasurable acceptance criterion (at: REQ-04, AC-04.7)
  Suggestion: Change to character-based limit (12,000 characters ~3k tokens) with rationale
- [warning] [prerequisite] AC-03.2 mentions npx but does not document Node.js as a runtime prerequisite (at: REQ-03, AC-03.2)
  Suggestion: Add explicit prerequisite note about Node.js requirement
- [warning] [implementation detail] AC-04.3 needs to specify schema discovery mechanism (direct SQLite vs MCP) (at: REQ-04, AC-04.3)
  Suggestion: Specify direct SQLite connection to avoid MCP complexity at startup
- [warning] [enforcement mechanism] AC-05.3 should clarify filesystem permissions as primary read-only mechanism (at: REQ-05, AC-05.3)
  Suggestion: Specify chmod 444 and filesystem permissions as primary enforcement
- [warning] [implementation detail] AC-06.5 needs to specify how SQL queries are captured from Agent SDK messages (at: REQ-06, AC-06.5)
  Suggestion: Specify inspection of AssistantMessage tool use blocks matching mcp__sqlite__*
- [suggestion] [cost estimation] AC-06.2 cost_estimate needs a calculation method or null fallback (at: REQ-06, AC-06.2)
  Suggestion: Specify token-based cost calculation with null fallback if token counts unavailable
- [suggestion] [data quality] AC-03.5 should specify data distribution requirements for meaningful analysis (at: REQ-03, AC-03.5)
  Suggestion: Add requirement for varied order counts across months

**Changes Made:**
- AC-02.9: Changed from Agent SDK timeout parameter to `asyncio.wait_for()` wrapper with 240s timeout, added rationale about LiteLLM proxy's 300s default
- AC-04.7: Changed from 3000 tokens to 12,000 characters (~3k tokens) with cost rationale
- AC-03.2: Added "Prerequisite: Node.js (with npx) must be available in the runtime environment"
- AC-04.3: Specified direct SQLite connection via `sqlite_master` query, not via MCP
- AC-05.3: Specified `chmod 444` filesystem permissions as primary mechanism
- AC-06.5: Specified AssistantMessage inspection with mcp__sqlite__* tool name matching
- AC-06.2: Added cost calculation formula and null fallback when token counts unavailable
- AC-03.5: Added distribution requirements (6+ calendar months, varied order counts)

---

## Stage 2: Phase Review - Iteration 1 - 2026-02-07T13:15:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [warning] Section 4 references 30s query timeout but no AC specifies how this is detected or enforced (at: Section 4 vs REQ-02/REQ-03)
  Suggestion: Clarify 30s timeout is MCP server native behavior, or add corresponding AC
- [warning] AC-05.2 disallowed_tools list is narrower than PRD Section 4.5 (missing Glob, Grep) (at: REQ-05, AC-05.2 vs PRD 4.5)
  Suggestion: Note that allowed_tools wildcard implicitly blocks non-MCP tools, or expand list
- [warning] AC-06.7 non-blocking audit log unclear for streaming requests (at: REQ-06, AC-06.7)
  Suggestion: Clarify log is written after final SSE chunk, with in-memory accumulation during streaming
- [warning] AC-02.1 exact PyPI package name unverified (at: REQ-02, AC-02.1)
  Suggestion: Verify exact package name against PyPI at design time
- [suggestion] No minimum Python version specified (at: General)
  Suggestion: Add runtime requirements note (Python 3.10+, Node.js)
- [suggestion] No sample LiteLLM proxy config mentioned as deliverable (at: REQ-01, AC-01.3/AC-01.4)
  Suggestion: Add AC for sample proxy config YAML
- [suggestion] No test framework specified (at: Section 6)
  Suggestion: Note pytest as preferred framework

**Changes Made:**
Phase-reviewer notes recorded. No blocking issues — warnings and suggestions deferred to design phase.

---

## Design Review - Iteration 1 - 2026-02-07T14:15:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision (3 blockers, 7 warnings)

**Issues:**
- [blocker] [feasibility] Design uses wrong SDK package name: says 'claude-code-sdk' / 'ClaudeCodeOptions' but actual package is 'claude-agent-sdk' / 'ClaudeAgentOptions' (at: Section 0, 1.2, 1.3)
  Challenge: What is the exact PyPI package name, import path, and class name?
- [blocker] [completeness] No specification of how ClaudeDAError exceptions are translated to LiteLLM's CustomLLMError(status_code, message) (at: Section 2.2, 2.7, 1.6)
  Challenge: Without CustomLLMError translation, LiteLLM returns generic 500 instead of intended error codes
- [blocker] [feasibility] Agent SDK query() takes prompt:str, not messages list. No conversion strategy specified (at: Section 2.6, 1.3)
  Challenge: How are OpenAI-format messages converted to SDK's prompt parameter? AC-01.8 requires full history forwarding.
- [warning] [completeness] Spec error table has 'query_timeout' code but no exception or detection mechanism in design (at: Section 1.5, 1.6, 2.2)
- [warning] [consistency] run_streaming uses self.last_result (mutable instance state) — race condition for concurrent requests (at: Section 2.6)
- [warning] [completeness] GenericStreamingChunk missing usage field in final chunk (at: Section 2.6, 2.7)
- [warning] [assumptions] AuditLogger.log() is sync but called from async context — blocks event loop (at: Section 2.5, 1.3)
- [warning] [completeness] completion() sync-to-async delegation mechanism unspecified (at: Section 2.7)
- [warning] [feasibility] Module-level instance runs full init at import time — fragile (at: Section 2.7)
- [warning] [completeness] verify_read_only() referenced but not defined in any interface (at: Section 2.7 step 3)

**Changes Made:**
- Fixed SDK package name: `claude-agent-sdk` (PyPI), `claude_agent_sdk` (import), `ClaudeAgentOptions` (class)
- Added CustomLLMError translation: `_handle_error()` catches ClaudeDAError and re-raises as CustomLLMError
- Added `_messages_to_prompt()` conversion strategy: single message → direct, multi-turn → labeled format
- Added query_timeout clarification: MCP server native, handled within agent loop, not separately surfaced
- Changed run_streaming to return tuple (iterator, future) — no mutable instance state
- Added usage field to final GenericStreamingChunk with token counts from ResultMessage
- Changed AuditLogger.log() to async with asyncio.to_thread() for file writes
- Changed completion()/streaming() to raise NotImplementedError (proxy uses async only)
- Changed to lazy initialization: _ensure_initialized() on first request with asyncio.Lock
- Added verify_read_only() definition in schema.py section

---

## Handoff Review - 2026-02-07T14:30:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [warning] agent.py dependency table lists 'prompt' but agent takes system_prompt as string — prompt.py dependency is actually on provider.py (at: Section 1.1)
  Suggestion: Update dependency table and flow text
- [warning] Spec error table defines query_timeout as HTTP 504 but design explicitly does not surface it — spec deviation should be acknowledged formally (at: Section 1.6 vs spec Section 4)
  Suggestion: Add spec deviations subsection or update spec error table
- [suggestion] _error_type() helper referenced but not defined (at: Section 2.2)
  Suggestion: Add one-line mapping note
- [suggestion] permission_mode value not specified in ClaudeAgentOptions config (at: Section 1.3 step 5)
  Suggestion: Specify value or note 'uses SDK default'

---
