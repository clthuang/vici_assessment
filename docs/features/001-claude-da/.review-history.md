# Review History: 001-claude-da (specify phase)

## Stage 1: Spec-Reviewer Review - Iteration 1 - 2026-02-07T13:00:00Z

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [feasibility] AC-02.9 claims Agent SDK has a timeout parameter, but ClaudeAgentOptions has no `timeout` field (at: REQ-02, AC-02.9)
  Suggestion: Use `asyncio.wait_for()` wrapper around the `query()` call with 240s timeout
- [blocker] [measurability] AC-04.7 references "3000 tokens" without specifying tokenizer — unmeasurable acceptance criterion (at: REQ-04, AC-04.7)
  Suggestion: Change to character-based limit (12,000 characters ~3k tokens) with rationale
- [warning] [prerequisite] AC-03.2 mentions npx but does not document Node.js as a runtime prerequisite (at: REQ-03, AC-03.2)
  Suggestion: Add explicit prerequisite note about Node.js requirement
- [warning] [implementation detail] AC-04.3 needs to specify schema discovery mechanism (direct SQLite vs MCP) (at: REQ-04, AC-04.3)
  Suggestion: Specify direct SQLite connection to avoid MCP complexity at startup
- [warning] [enforcement mechanism] AC-05.3 should clarify filesystem permissions as primary read-only mechanism (at: REQ-05, AC-05.3)
  Suggestion: Specify chmod 444 and filesystem permissions as primary enforcement
- [warning] [implementation detail] AC-06.5 needs to specify how SQL queries are captured from Agent SDK messages (at: REQ-06, AC-06.5)
  Suggestion: Specify inspection of AssistantMessage tool use blocks matching mcp__sqlite__*
- [suggestion] [cost estimation] AC-06.2 cost_estimate needs a calculation method or null fallback (at: REQ-06, AC-06.2)
  Suggestion: Specify token-based cost calculation with null fallback if token counts unavailable
- [suggestion] [data quality] AC-03.5 should specify data distribution requirements for meaningful analysis (at: REQ-03, AC-03.5)
  Suggestion: Add requirement for varied order counts across months

**Changes Made:**
- AC-02.9: Changed from Agent SDK timeout parameter to `asyncio.wait_for()` wrapper with 240s timeout, added rationale about LiteLLM proxy's 300s default
- AC-04.7: Changed from 3000 tokens to 12,000 characters (~3k tokens) with cost rationale
- AC-03.2: Added "Prerequisite: Node.js (with npx) must be available in the runtime environment"
- AC-04.3: Specified direct SQLite connection via `sqlite_master` query, not via MCP
- AC-05.3: Specified `chmod 444` filesystem permissions as primary mechanism
- AC-06.5: Specified AssistantMessage inspection with mcp__sqlite__* tool name matching
- AC-06.2: Added cost calculation formula and null fallback when token counts unavailable
- AC-03.5: Added distribution requirements (6+ calendar months, varied order counts)

---

## Stage 2: Phase Review - Iteration 1 - 2026-02-07T13:15:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [warning] Section 4 references 30s query timeout but no AC specifies how this is detected or enforced (at: Section 4 vs REQ-02/REQ-03)
  Suggestion: Clarify 30s timeout is MCP server native behavior, or add corresponding AC
- [warning] AC-05.2 disallowed_tools list is narrower than PRD Section 4.5 (missing Glob, Grep) (at: REQ-05, AC-05.2 vs PRD 4.5)
  Suggestion: Note that allowed_tools wildcard implicitly blocks non-MCP tools, or expand list
- [warning] AC-06.7 non-blocking audit log unclear for streaming requests (at: REQ-06, AC-06.7)
  Suggestion: Clarify log is written after final SSE chunk, with in-memory accumulation during streaming
- [warning] AC-02.1 exact PyPI package name unverified (at: REQ-02, AC-02.1)
  Suggestion: Verify exact package name against PyPI at design time
- [suggestion] No minimum Python version specified (at: General)
  Suggestion: Add runtime requirements note (Python 3.10+, Node.js)
- [suggestion] No sample LiteLLM proxy config mentioned as deliverable (at: REQ-01, AC-01.3/AC-01.4)
  Suggestion: Add AC for sample proxy config YAML
- [suggestion] No test framework specified (at: Section 6)
  Suggestion: Note pytest as preferred framework

**Changes Made:**
Phase-reviewer notes recorded. No blocking issues — warnings and suggestions deferred to design phase.

---
