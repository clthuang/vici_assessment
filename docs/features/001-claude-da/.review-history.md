# Review History: 001-claude-da

## Stage 1: Spec-Reviewer Review - Iteration 1 - 2026-02-07T13:00:00Z

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [feasibility] AC-02.9 claims Agent SDK has a timeout parameter, but ClaudeAgentOptions has no `timeout` field (at: REQ-02, AC-02.9)
  Suggestion: Use `asyncio.wait_for()` wrapper around the `query()` call with 240s timeout
- [blocker] [measurability] AC-04.7 references "3000 tokens" without specifying tokenizer — unmeasurable acceptance criterion (at: REQ-04, AC-04.7)
  Suggestion: Change to character-based limit (12,000 characters ~3k tokens) with rationale
- [warning] [prerequisite] AC-03.2 mentions npx but does not document Node.js as a runtime prerequisite (at: REQ-03, AC-03.2)
  Suggestion: Add explicit prerequisite note about Node.js requirement
- [warning] [implementation detail] AC-04.3 needs to specify schema discovery mechanism (direct SQLite vs MCP) (at: REQ-04, AC-04.3)
  Suggestion: Specify direct SQLite connection to avoid MCP complexity at startup
- [warning] [enforcement mechanism] AC-05.3 should clarify filesystem permissions as primary read-only mechanism (at: REQ-05, AC-05.3)
  Suggestion: Specify chmod 444 and filesystem permissions as primary enforcement
- [warning] [implementation detail] AC-06.5 needs to specify how SQL queries are captured from Agent SDK messages (at: REQ-06, AC-06.5)
  Suggestion: Specify inspection of AssistantMessage tool use blocks matching mcp__sqlite__*
- [suggestion] [cost estimation] AC-06.2 cost_estimate needs a calculation method or null fallback (at: REQ-06, AC-06.2)
  Suggestion: Specify token-based cost calculation with null fallback if token counts unavailable
- [suggestion] [data quality] AC-03.5 should specify data distribution requirements for meaningful analysis (at: REQ-03, AC-03.5)
  Suggestion: Add requirement for varied order counts across months

**Changes Made:**
- AC-02.9: Changed from Agent SDK timeout parameter to `asyncio.wait_for()` wrapper with 240s timeout, added rationale about LiteLLM proxy's 300s default
- AC-04.7: Changed from 3000 tokens to 12,000 characters (~3k tokens) with cost rationale
- AC-03.2: Added "Prerequisite: Node.js (with npx) must be available in the runtime environment"
- AC-04.3: Specified direct SQLite connection via `sqlite_master` query, not via MCP
- AC-05.3: Specified `chmod 444` filesystem permissions as primary mechanism
- AC-06.5: Specified AssistantMessage inspection with mcp__sqlite__* tool name matching
- AC-06.2: Added cost calculation formula and null fallback when token counts unavailable
- AC-03.5: Added distribution requirements (6+ calendar months, varied order counts)

---

## Stage 2: Phase Review - Iteration 1 - 2026-02-07T13:15:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [warning] Section 4 references 30s query timeout but no AC specifies how this is detected or enforced (at: Section 4 vs REQ-02/REQ-03)
  Suggestion: Clarify 30s timeout is MCP server native behavior, or add corresponding AC
- [warning] AC-05.2 disallowed_tools list is narrower than PRD Section 4.5 (missing Glob, Grep) (at: REQ-05, AC-05.2 vs PRD 4.5)
  Suggestion: Note that allowed_tools wildcard implicitly blocks non-MCP tools, or expand list
- [warning] AC-06.7 non-blocking audit log unclear for streaming requests (at: REQ-06, AC-06.7)
  Suggestion: Clarify log is written after final SSE chunk, with in-memory accumulation during streaming
- [warning] AC-02.1 exact PyPI package name unverified (at: REQ-02, AC-02.1)
  Suggestion: Verify exact package name against PyPI at design time
- [suggestion] No minimum Python version specified (at: General)
  Suggestion: Add runtime requirements note (Python 3.10+, Node.js)
- [suggestion] No sample LiteLLM proxy config mentioned as deliverable (at: REQ-01, AC-01.3/AC-01.4)
  Suggestion: Add AC for sample proxy config YAML
- [suggestion] No test framework specified (at: Section 6)
  Suggestion: Note pytest as preferred framework

**Changes Made:**
Phase-reviewer notes recorded. No blocking issues — warnings and suggestions deferred to design phase.

---

## Design Review - Iteration 1 - 2026-02-07T14:15:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision (3 blockers, 7 warnings)

**Issues:**
- [blocker] [feasibility] Design uses wrong SDK package name: says 'claude-code-sdk' / 'ClaudeCodeOptions' but actual package is 'claude-agent-sdk' / 'ClaudeAgentOptions' (at: Section 0, 1.2, 1.3)
  Challenge: What is the exact PyPI package name, import path, and class name?
- [blocker] [completeness] No specification of how ClaudeDAError exceptions are translated to LiteLLM's CustomLLMError(status_code, message) (at: Section 2.2, 2.7, 1.6)
  Challenge: Without CustomLLMError translation, LiteLLM returns generic 500 instead of intended error codes
- [blocker] [feasibility] Agent SDK query() takes prompt:str, not messages list. No conversion strategy specified (at: Section 2.6, 1.3)
  Challenge: How are OpenAI-format messages converted to SDK's prompt parameter? AC-01.8 requires full history forwarding.
- [warning] [completeness] Spec error table has 'query_timeout' code but no exception or detection mechanism in design (at: Section 1.5, 1.6, 2.2)
- [warning] [consistency] run_streaming uses self.last_result (mutable instance state) — race condition for concurrent requests (at: Section 2.6)
- [warning] [completeness] GenericStreamingChunk missing usage field in final chunk (at: Section 2.6, 2.7)
- [warning] [assumptions] AuditLogger.log() is sync but called from async context — blocks event loop (at: Section 2.5, 1.3)
- [warning] [completeness] completion() sync-to-async delegation mechanism unspecified (at: Section 2.7)
- [warning] [feasibility] Module-level instance runs full init at import time — fragile (at: Section 2.7)
- [warning] [completeness] verify_read_only() referenced but not defined in any interface (at: Section 2.7 step 3)

**Changes Made:**
- Fixed SDK package name: `claude-agent-sdk` (PyPI), `claude_agent_sdk` (import), `ClaudeAgentOptions` (class)
- Added CustomLLMError translation: `_handle_error()` catches ClaudeDAError and re-raises as CustomLLMError
- Added `_messages_to_prompt()` conversion strategy: single message → direct, multi-turn → labeled format
- Added query_timeout clarification: MCP server native, handled within agent loop, not separately surfaced
- Changed run_streaming to return tuple (iterator, future) — no mutable instance state
- Added usage field to final GenericStreamingChunk with token counts from ResultMessage
- Changed AuditLogger.log() to async with asyncio.to_thread() for file writes
- Changed completion()/streaming() to raise NotImplementedError (proxy uses async only)
- Changed to lazy initialization: _ensure_initialized() on first request with asyncio.Lock
- Added verify_read_only() definition in schema.py section

---

## Handoff Review - 2026-02-07T14:30:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [warning] agent.py dependency table lists 'prompt' but agent takes system_prompt as string — prompt.py dependency is actually on provider.py (at: Section 1.1)
  Suggestion: Update dependency table and flow text
- [warning] Spec error table defines query_timeout as HTTP 504 but design explicitly does not surface it — spec deviation should be acknowledged formally (at: Section 1.6 vs spec Section 4)
  Suggestion: Add spec deviations subsection or update spec error table
- [suggestion] _error_type() helper referenced but not defined (at: Section 2.2)
  Suggestion: Add one-line mapping note
- [suggestion] permission_mode value not specified in ClaudeAgentOptions config (at: Section 1.3 step 5)
  Suggestion: Specify value or note 'uses SDK default'

---

## Stage 1: Plan Review - Iteration 1 - 2026-02-07T15:15:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision (4 blockers, 7 warnings)

**Issues:**
- [blocker] [assumption] `_messages_to_prompt()` serialization strategy unspecified — query() takes `prompt: str`, not messages (at: Phase 3.1)
  Suggestion: Document exact serialization format and limitations vs AC-01.8
- [blocker] [assumption] MCP server config uses plain dicts in SDK examples, not imported TypedDicts — import assumption unverified (at: Phase 3.1)
  Suggestion: Use dict literals matching McpStdioServerConfig schema
- [blocker] [assumption] `permission_mode` not specified — SDK defaults to interactive approval, hangs in headless server (at: Phase 3.1)
  Suggestion: Set `permission_mode="bypassPermissions"` explicitly
- [blocker] [tdd-order] Git does not preserve chmod 444 — committing demo.db breaks read-only enforcement after clone (at: Phase 2.1)
  Suggestion: Generate demo.db at setup time instead of committing binary
- [warning] [failure-mode] Streaming returns tuple but astreaming() must return AsyncIterator — audit coordination unclear (at: Phase 3.2, 4.3)
- [warning] [assumption] `claude-agent-sdk>=0.1.30` needs upper bound for API stability (at: Phase 1.1)
- [warning] [failure-mode] Lazy init failure not cached — cascading retries on every request (at: Phase 4.1)
- [warning] [dependency] Diagram omits schema.py→config.py and prompt.py→exceptions.py edges (at: Dependencies)
- [warning] [feasibility] SQL extraction tool names and input field structure not specified (at: Phase 3.1)
- [warning] [assumption] litellm version not pinned with upper bound (at: Phase 1.1)
- [warning] [failure-mode] Fire-and-forget task exceptions cause "never retrieved" warnings (at: Phase 4.2)

**Changes Made:**
- Phase 3.1: Added full `_messages_to_prompt()` serialization strategy (single message → direct, multi-turn → labeled turns, system → skipped), documented limitation vs AC-01.8
- Phase 3.1: Changed MCP server config to use plain dicts (official SDK pattern), not imported TypedDicts
- Phase 3.1: Set `permission_mode="bypassPermissions"` with security rationale
- Phase 2.1: Changed to generate demo.db at setup time (not committed to repo), README includes seed command
- Phase 3.2: Changed streaming to use mutable container for audit result instead of Future return
- Phase 1.1: Added upper bounds: `claude-agent-sdk>=0.1.30,<0.2.0`, `litellm>=1.0,<2.0`
- Phase 4.1: Added init failure caching — subsequent requests return cached error immediately
- Dependencies diagram: Added cross-edges for schema→config and prompt→exceptions
- Phase 3.1: Specified exact MCP tool names (`mcp__sqlite__read_query`, etc.) and input field extraction
- Phase 4.2: Added `task.add_done_callback()` for fire-and-forget exception suppression
- Phase 4.3: Clarified streaming audit coordination via result container pattern
- Phase 5.2: Clarified read-only enforcement test validates filesystem permissions (Layer 3) since wildcard matches write_query

---

## Stage 2: Chain Review - Iteration 1 - 2026-02-07T15:30:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [warning] 4.2 and 4.3 (acompletion/astreaming) shown as sequential but are independent — could be parallelized (at: Dependencies diagram)
  Suggestion: Note they both depend on 4.1 but not on each other
- [warning] Phase 3 gate says "After 3.1" but streaming (3.2) also needs live SDK — gate should encompass both or note fallback applies to streaming too (at: Risk Mitigation Checkpoints)
  Suggestion: Change gate to "After 3.2" or add note
- [warning] AgentResult.query_results capture from tool result messages not mentioned in Phase 3.1 iteration bullet (at: Phase 3.1)
  Suggestion: Add capture of query results for verbose audit logging (AC-06.6)
- [warning] Phase 2.2 tests reference demo.db but should clarify whether tests use seeder output or create a fixture DB (at: Phase 2.2)
  Suggestion: Prefer pytest fixture with temp DB for unit test isolation
- [suggestion] Dev dependencies (pytest, pytest-asyncio, ruff, mypy) not listed in Phase 1.1 (at: Phase 1.1)
  Suggestion: Add dev dependency bullet
- [suggestion] Design Section 2.9 still says "committed to repository" but plan changed to seeder-at-setup-time (at: Design vs Plan inconsistency)
  Suggestion: Update design.md to match

**Changes Made:**
Phase-reviewer approved. Warnings noted — minor gaps addressable during task creation.

---

## Stage 1: Plan Review - Iteration 2 - 2026-02-07T15:45:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Approved (0 blockers, 7 warnings, 2 notes)

**Issues:**
- [warning] Design Section 2.6 still shows tuple return for run_streaming() — plan correctly uses container pattern; design should be updated (at: Phase 3.2 vs Design Section 2.6)
- [warning] bypassPermissions eliminates interactive approval fallback — three-layer safety architecture mitigates (at: Phase 3.1)
- [warning] ResultMessage.usage may be None — streaming final chunk and audit need null handling (at: Phase 3.1, 3.2)
- [warning] Schema text 12K limit same as full prompt limit — should be tighter to leave room for role/rules (at: Phase 2.2)
- [note] GenericStreamingChunk may need `tool_use: None` field to match LiteLLM reference (at: Phase 3.2)
- [note] Phase 2.2 unit tests correctly isolated from seeder via fixture — good TDD design (at: Phase 2.1, 2.2)

**Changes Made:**
All previous blockers resolved. Plan approved — remaining warnings are implementation-level details.

---

## Task Review Iteration 1 - 2026-02-07T16:15:00Z

**Decision:** Approved

**Issues:**
- [warning] T-021 is an exceptionally large task (30-45 min) — could be split but description is unambiguous → no action needed
- [warning] T-027 similarly dense — multiple logical units but detailed enough for implementation → no action needed
- [warning] Spec's `query_timeout` error code (30s MCP timeout) not explicitly addressed in tasks → add note to T-021
- [warning] Phase 2 Groups 2.1 and 2.2 have independent dependency chains but summary says "1 sequential chain" → fix summary
- [suggestion] T-018 and T-019 are very small (could be combined) — inconsistent granularity with T-021/T-027 → acceptable
- [suggestion] Summary table says "6 parallel groups" but only Phase 4 has explicit parallelism → clarify labeling

**Changes Made:**
- T-012, T-013, T-014: Added explicit "Done when" acceptance criteria (blocker resolved)
- T-021: Added note about query_timeout being handled natively by MCP server (design Section 1.5)
- Summary table: Clarified group counts and parallelism description per phase

---

## Task Chain Validation - 2026-02-07T16:20:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision (1 blocker: missing Done when criteria on T-012, T-013, T-014)

**Issues:**
- [blocker] T-012, T-013, T-014 lack explicit "Done when" acceptance criteria (at: Phase 2, Group 2.2)
- [warning] T-021 exceeds 15-min guideline (at: Phase 3, Group 3.1)
- [warning] T-027 similarly dense (at: Phase 4, Group 4.1)
- [warning] query_timeout error code not explicitly addressed in tasks (at: Spec Section 4 vs tasks)
- [warning] Phase 2 parallelism not reflected in summary (at: Summary table)
- [suggestion] T-018, T-019 granularity inconsistent with larger tasks (at: Phase 3)
- [suggestion] "6 parallel groups" count unclear (at: Summary table)

**Changes Made:**
All issues addressed — see Task Review Iteration 1 changes above.

---

## Task Chain Validation - Iteration 2 - 2026-02-07T16:30:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved (0 blockers, 1 warning, 2 suggestions)

**Issues:**
- [warning] Phase 2 summary says "merge at T-015" but 2.1 and 2.2 never merge — T-015 depends only on Group 2.2 tasks, Group 2.1 feeds Phase 3 integration tests (at: Summary table, Phase 2)
- [suggestion] Group 5.2 integration tests marked "after 5.1" but have no README dependency — unnecessary sequencing (at: Phase 5, Group 5.2)
- [suggestion] T-011 depends on T-003 (exceptions) but dataclasses don't use exceptions — T-012/T-013 are the ones that need it (at: T-011)

**Changes Made:**
- Phase 2 summary reworded: "2.1 independent, 2.2 sequential, then 2.3 after 2.2; 2.1 feeds Phase 3 integration"
- Group 5.2 changed to "parallel with 5.1, after Phase 4"
- T-011 dependency changed from T-003 to T-002 (dataclasses only need package init, not exceptions)

---
