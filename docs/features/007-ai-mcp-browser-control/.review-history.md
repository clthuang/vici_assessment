# Review History: Feature 007 - AI Browser Orchestration

## PIVOT NOTICE - 2026-02-05T15:30:00Z

**Original approach (v1)**: Build custom browser control tools from scratch
- 7 custom tools, element registry, snapshot factory
- 52 implementation tasks, 50+ hours estimated
- Archived to `./archive/`

**New approach (v2)**: Orchestrate existing MCP tools
- Leverage Playwright MCP, browser-use, mcp-use libraries
- ~15 tasks, 13-20 hours estimated
- Focus on thin orchestration layer + service-specific logic

**Reason for pivot**: User correctly identified that existing MCP tools (Playwright MCP, browser-use) already provide browser control. Building from scratch was unnecessary.

---

# Review History (v2 - Orchestration Approach)

## Stage 1: Spec-Skeptic Review - Iteration 1 - 2026-02-05T16:30:00Z

**Reviewer:** spec-skeptic (skeptic)
**Decision:** Needs Revision (3 blockers identified)

**Issues:**
- [blocker] [testability] Checkpoint conditions marked TBD - cannot write tests (at: Section 2.5.3)
  Suggestion: Add concrete Netflix checkpoint predicates
- [blocker] [assumptions] Snapshot data structure undefined - checkpoint logic cannot be implemented (at: Section 2.5.2)
  Suggestion: Add NormalizedSnapshot interface with concrete fields
- [blocker] [traceability] Netflix success/failure indicators not defined in Section 2.6.2 (at: Section 2.6.3)
  Suggestion: Add explicit success_indicators and failure_indicators

**Changes Made:**
1. Added NormalizedSnapshot dataclass with url, title, content, screenshot_path fields
2. Added normalize_snapshot() function spec with validation requirements
3. Added concrete NETFLIX_CHECKPOINT_CONDITIONS predicates
4. Added AC-5.5 and AC-5.6 for snapshot validation
5. Added NETFLIX_SUCCESS_INDICATORS and NETFLIX_FAILURE_INDICATORS to Section 2.6.2

---

## Stage 1: Spec-Skeptic Review - Iteration 2 - 2026-02-05T16:45:00Z

**Reviewer:** spec-skeptic (skeptic)
**Decision:** Approved (warnings only)

**Issues:**
- [warning] [assumptions] NormalizedSnapshot.screenshot_path typed as str but described as optional (at: Section 2.5.2)
  Suggestion: Change to `str | None = None`
- [warning] [testability] Edge case detection for 2FA/CAPTCHA not specified (at: Section 2.7.3)
  Suggestion: Add detection predicates
- [warning] [assumptions] complete_task(status="failed") behavior unspecified (at: Section 2.6.3)
  Suggestion: Document that failure is trusted without verification
- [warning] [testability] Turn latency NFR depends on external factors (at: Section 3.1)
  Suggestion: Clarify as target, add hard timeout
- [warning] [clarity] --dry-run behavior not specified (at: Section 2.8.3)
  Suggestion: Add dry-run behavior section
- [warning] [assumptions] No retry limit for no-action LLM responses (at: Section 2.4.2)
  Suggestion: Add 3-retry limit with llm_no_action termination
- [warning] [traceability] PRD mentions error recovery but spec doesn't specify mechanism (at: Section 2.4)
  Suggestion: Add error recovery section

**Changes Made:**
1. Fixed NormalizedSnapshot.screenshot_path to `str | None = None`
2. Added AUTH_EDGE_CASE_DETECTORS for 2FA/CAPTCHA/session detection
3. Added explicit complete_task(status="failed") handling
4. Added no-action retry limit (3) with llm_no_action termination
5. Added Section 2.4.5 Error Recovery
6. Added Section 2.8.5 Dry Run Behavior
7. Clarified turn latency as target with 60s hard timeout
8. Added TaskReason enum for structured reason values
9. Added AC-4.5 for no-action handling, AC-8.6 for dry-run

---

## Stage 2: Phase Review - Iteration 1 - 2026-02-05T17:00:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision (3 warnings)

**Issues:**
- [warning] AC-7.1 tests profile but Section 2.7.1 doesn't specify how to configure Playwright MCP profile path
  Suggestion: Add explicit command-line arguments for profile configuration
- [warning] Section 2.5.2 NormalizedSnapshot POC note unclear - is POC done or speculative?
  Suggestion: Mark as "TBD in Phase 1" and add AC for validation
- [warning] Section 2.4.5 Error Recovery has no AC for MCPToolError behavior
  Suggestion: Add AC-4.6 for error formatting
- [suggestion] No AC for 60s LLM timeout behavior
- [suggestion] Verification failure message format unspecified
- [suggestion] Multiple tool_calls handling not documented

**Changes Made:**
1. Added explicit Playwright MCP profile configuration with --user-data-dir flag
2. Clarified normalize_snapshot() as "TBD in Phase 1 (POC)"
3. Added AC-4.6 for MCPToolError formatting
4. Added AC-2.5 for 60s LLM timeout
5. Added AC-5.7 for POC validation of normalize_snapshot
6. Specified verification failure message format with JSON example
7. Documented multiple tool_calls handling behavior (log debug, no warning)

---

## Stage 2: Phase Review - Iteration 2 - 2026-02-05T17:15:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Verification:** All 6 previous issues correctly addressed:
- ✓ Profile configuration with --user-data-dir flag
- ✓ NormalizedSnapshot POC note clarified
- ✓ AC-4.6 for MCPToolError formatting
- ✓ AC-2.5 for 60s LLM timeout
- ✓ AC-5.7 for POC validation
- ✓ Verification failure JSON format
- ✓ Multiple tool_calls debug logging

**Issues:**
- [suggestion] Section 2.4.5 location after AC table could cause confusion → Added "(AC-4.6 Detail)" clarification
- [suggestion] Fallback strategy forward reference unclear → Changed to "to be determined in design phase"

**Summary:** Spec has 39 comprehensive acceptance criteria covering all 7 functional requirements. Ready for design phase.

---

# Review History (v1 - ARCHIVED): Feature 007 - AI-Led MCP Browser Control

## Stage 1: Spec-Skeptic Review - Iteration 1 - 2026-02-05T11:00:00Z

**Reviewer:** spec-skeptic (skeptic)
**Decision:** Needs Revision (4 blockers identified)

**Issues:**
- [blocker] [testability] NFR1 references 'cl100k_base equivalent' tokenizer for Claude, but Claude uses its own tokenizer. (at: Section 2.1.2)
  Suggestion: Use empirical measurement via anthropic SDK's usage.input_tokens
- [blocker] [assumptions] browser_scroll tool makes both 'ref' and 'direction' optional with no validation rule. (at: Section 1.1.3, T5)
  Suggestion: Add explicit behavior rules for parameter combinations
- [blocker] [testability] AC-P3 threshold inconsistent with NFR1 targets. No methodology for token measurement. (at: Section 3.7 vs 2.1.1)
  Suggestion: Clarify measurement method and thresholds
- [blocker] [traceability] PRD FR6 mentions human can 'provide guidance' but spec doesn't specify how guidance flows back to AI. (at: Section 1.6.3)
  Suggestion: Specify message format and conversation context append
- [warning] [assumptions] Element pruning rule 4 mentions 'onclick handler' but accessibility tree doesn't expose event handlers. (at: Section 1.3.2)
  Suggestion: Replace with detectable criterion like tabindex/focusability
- [warning] [clarity] 'Prominence' not defined for pruning when >100 elements. (at: Section 1.3.3)
  Suggestion: Define explicit ranking criteria
- [warning] [testability] No acceptance criterion for AI response latency timeout. (at: Section 2.2.1 vs 3.7)
  Suggestion: Add AC-P4 for 30s timeout
- [warning] [assumptions] History truncation summary format and generator unspecified. (at: Section 2.1.3)
  Suggestion: Specify system generates bullet list of tool calls and outcomes
- [warning] [assumptions] Verification logic only covers status='success', not status='failed'. (at: Section 1.7.3)
  Suggestion: Add failure verification logic
- [warning] [testability] AC-R2 says 'consistent document order' but should link to depth-first traversal spec. (at: Section 3.2)
  Suggestion: Rewrite to reference traversal method explicitly
- [warning] [clarity] Error code 'action_failed' overlaps with specific codes. (at: Section 1.1.2)
  Suggestion: Clarify precedence of specific codes
- [suggestion] [testability] Acceptance criteria lack Given/When/Then structure.
- [suggestion] [clarity] Step 5 prompt text is implementation detail.
- [suggestion] [clarity] Document uses both 'turn' and 'cycle' terminology.

**Changes Made:**
1. Fixed tokenizer reference - now specifies empirical measurement via Claude API
2. Added browser_scroll parameter rules with explicit behavior for all combinations
3. Added invalid_params error code
4. Clarified AC-P3 measurement methodology
5. Added AC-P4 for AI response timeout
6. Expanded checkpoint rejection response format with guidance feedback flow
7. Replaced onclick handler criterion with focusability
8. Added element pruning priority ranking (viewport > role priority > document order)
9. Added action summary format specification for history truncation
10. Added failure verification logic (acknowledged=true, logged for debugging)
11. Rewrote AC-R2 to reference depth-first traversal
12. Clarified action_failed as fallback error code

---

## Stage 2: Phase Review - Iteration 1 - 2026-02-05T11:15:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [warning] JSON schema file format for snapshot validation not explicitly defined. (at: Section 2.3.3)
  Suggestion: Note that TypeScript interface serves as schema definition
- [warning] History truncation timing and generator not fully clarified. (at: Section 2.1.3)
  Suggestion: Clarify truncation checked at start of each turn
- [suggestion] Phase 0 validation criteria from PRD not referenced in spec.
- [suggestion] browser_scroll parameter rules are outside JSON block, could be overlooked.

**Summary:** Spec approved for design phase. All 7 tools fully specified with schemas, error codes, and acceptance criteria. Minor documentation improvements suggested but no blockers.

---

## Design Review - Iteration 1 - 2026-02-05T12:30:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision (3 blockers identified)

**Issues:**
- [blocker] [completeness] HumanApprovalHandler integration underspecified in TaskOrchestrator. Missing control flow for server-enforced vs AI-requested approvals. (at: Section 2.1, 9.4.1)
  Challenge: What is the exact control flow when a checkpoint triggers?
- [blocker] [consistency] request_human_approval and complete_task tool implementations claim they're handled by orchestrator but no mechanism shown. (at: Section 9.4.3, 9.4.1)
  Challenge: What is the exact call path for these tools?
- [blocker] [completeness] SnapshotFactory returns tuple but data flow to ElementRegistry not shown. (at: Section 2.3, 9.4.5)
  Challenge: Show complete flow from snapshot creation to ref assignment.
- [warning] [consistency] ActionExecutor interface shows raising exceptions but Section 2.6 shows returning ActionResult.
- [warning] [completeness] Token estimation hand-waved in Section 3.4.
- [warning] [assumptions] Bounding box fallback not shown in SnapshotFactory.
- [warning] [completeness] ToolRegistry in architecture diagram but no interface definition.
- [warning] [completeness] Retry logic not shown in AIClient.
- [note] Model version should be configurable.
- [note] CLI integration deferred.

**Changes Made:**
1. Added complete human approval control flow documentation with two sources (server-enforced vs AI-requested)
2. Added complete_task control flow documentation
3. Expanded TaskOrchestrator with _execute_tool, _handle_human_approval, _handle_complete_task methods
4. Added BrowserToolServer data flow showing snapshot → registry → result pipeline
5. Added _refresh_snapshot method and expanded execute() with routing logic
6. Updated SnapshotFactory to return tuple[Snapshot, list[ElementInfo]] with full explanation
7. Added bounding box strategy documentation
8. Clarified ActionExecutor raises exceptions (BrowserToolServer catches and converts to ToolResult)
9. Added note explaining ToolRegistry is collapsed into BrowserToolServer.execute()

---

## Stage 1: Plan Review - Iteration 1 - 2026-02-05T13:05:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision (3 blockers identified)

**Issues:**
- [blocker] [tdd-order] Phase 6 (Validation) scheduled AFTER full implementation (Phases 1-5), contradicting PRD mandate that validation must occur BEFORE building. (at: Phase 6 and Dependency Graph)
  Challenge: Why build P1-P5 before knowing if the hypothesis is valid?
- [blocker] [dependency] P0.6 (Snapshot Fixtures) not connected to P5.1/P6.1 in dependency graph. (at: Dependency Graph)
  Challenge: How can integration tests run without fixtures being complete?
- [blocker] [dependency] P3.1 (AIClient) missing dependency on P0.1 for types. (at: P3.1 Dependencies)
  Challenge: Is P0.1 a dependency of P3.1?
- [warning] [failure-mode] P7.1 depends on 'P6.2 (validation passed)' but no mechanism to enforce this gate.
- [warning] [assumption] P0.4 MockPlaywrightBrowser must implement all methods needed by SnapshotFactory.
- [warning] [failure-mode] P2.3 special tools return markers but could be called directly by mistake.
- [warning] [assumption] P1.2 needs tests for both bounding box paths (a11y tree vs fallback).
- [warning] [failure-mode] P5.2 doesn't test network error retry logic from NFR4.
- [warning] [dependency] P4.1 text says P2.1 dependency but needs P2.3.
- [warning] [tdd-order] P1.1 should test against interface before implementing.

**Changes Made:**
1. Restructured Phase 0 to include validation BEFORE full implementation
2. Added explicit VALIDATION GATE with pass/fail criteria
3. Changed P2.3 special tools to raise NotImplementedError instead of markers
4. Fixed dependency graph to show P0.5 → P5.1
5. Added P0.1 as explicit dependency of P3.1
6. Added bbox fallback tests to P1.2
7. Added network retry tests to P5.2
8. Added cost estimate to P0.7

---

## Stage 1: Plan Review - Iteration 2 - 2026-02-05T13:15:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Approved

**Issues:**
- [warning] [dependency] P3.1 dependency chain (P0.1 → P0.2 → P0.3 → P3.1) vs text listing could be clearer.
- [warning] [tdd-order] P0.6 includes 'Real AIClient' but P3.1 is production AIClient - relationship unclear.
- [warning] [failure-mode] Validation failure path doesn't specify concrete artifact preventing Phase 1 start.
- [warning] [assumption] Cost estimate (~200 API calls) may be optimistic given retries.
- [warning] [dependency] Confirm MockAIClient (P3.2) doesn't require P0.5 fixtures.
- [note] [feasibility] Consider performance test for bbox fallback <500ms assumption.

**Summary:** Revised plan successfully addresses previous blockers: Phase 0 validation gate is explicit, special tools raise NotImplementedError, dependency graph is corrected. Remaining issues are warnings about clarity in the validation-to-production transition for AIClient and minor dependency graph readability. Approved for implementation.

---

## Stage 2: Chain Review - 2026-02-05T13:20:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [warning] P0.6 bundles multiple components without explicit granularity for task breakdown. (at: Phase 0, P0.6)
  Suggestion: Break into sub-tasks during task creation
- [warning] Estimated cost '$2-5' in P0.7 is vague; no fallback if budget exceeded. (at: P0.7)
  Suggestion: Track actual spend and pause if costs exceed expectations
- [warning] P3.1 AIClient retry logic doesn't specify which errors trigger retry vs. immediate failure. (at: P3.1)
  Suggestion: Clarify retries apply to transient network errors, not 4xx/API errors
- [suggestion] Add critical path summary above dependency graph.
- [suggestion] Add explicit guidance on artifact handling if validation gate fails.
- [suggestion] Clarify P1.2 bbox test cases (a11y tree vs fallback paths).

**Summary:** The plan is well-structured with clear phases, explicit validation gate, TDD approach, and comprehensive dependency tracking. All design components are covered with files, deliverables, tests, and dependencies specified. Ready for task breakdown.

---

## Task Review - Iteration 1 - 2026-02-05T13:35:00Z

**Decision:** Needs Revision (6 blockers identified)

**Issues:**
- [blocker] T0.24: Ref assignment algorithm unspecified → Added: "refs as @e0, @e1... using depth-first traversal, reset to 0 on each call"
- [blocker] T0.27: API configuration missing → Added: "model claude-sonnet-4-20250514, ANTHROPIC_API_KEY env var, max_tokens=4096"
- [blocker] T0.29: Validation scenario goal missing → Added exact goal string and API error handling
- [blocker] T0.30: "Variations" undefined → Clarified: "same fixtures, fresh AI conversation each time"
- [blocker] T1.5: Priority ranking undefined → Added: "1) Interactive 2) Landmarks 3) Static text, preserve doc order within"
- [blocker] T3.3: History truncation ambiguous → Added: "10 message pairs = 1 turn, summary format with bullet list"
- [blocker] T4.2: Snapshot format unspecified → Added exact text format template
- [warning] T0.17: State enum missing → Added full list of valid state values
- [warning] T1.4: Non-binary done criteria → Fixed to specific assertions
- [warning] T3.4: 429 retry unclear → Clarified: retry 429, don't retry 400/401/403/404
- [warning] T5.1: Tool sequence missing → Added exact sequence with refs

**Changes Made:**
1. T0.24: Specified depth-first traversal, @e0 starting index, reset on each call
2. T0.27: Added model, env var, max_tokens configuration
3. T0.29: Added exact goal string and api_error failure mode
4. T0.30: Clarified no variations, CSV format specified
5. T1.5: Added explicit priority ranking algorithm
6. T3.3: Specified turn = message pair, summary format with examples
7. T4.2: Added exact _format_snapshot() output format
8. T0.17: Added full state enum list
9. T1.4: Changed to binary done criteria
10. T3.4: Clarified which HTTP errors to retry
11. T5.1: Added complete tool sequence with refs

---

## Task Review - Iteration 2 - 2026-02-05T13:45:00Z

**Decision:** Approved

**Issues:**
- [suggestion] T0.1-T0.4 parallel on same file could cause conflicts → Note: implement sequentially within file
- [suggestion] Summary metadata inconsistency → Minor, does not block

**Summary:** Task breakdown is comprehensive and executable. All plan items have corresponding tasks with proper TDD ordering. Dependencies are accurate, parallel groups are correctly identified, and each task has clear verification criteria.

---

## Task Chain Review - Iteration 1 - 2026-02-05T13:50:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision (5 concerns)

**Issues:**
- [warning] T0.1-T0.4 modify same file in parallel group.
- [warning] T1.2 should explicitly state counter reset behavior.
- [warning] T5.1 refs are dynamically assigned; need to align with fixtures.
- [warning] T0.17 includes 'selected' but spec doesn't list it.
- [warning] T1.5 should include viewport visibility ranking from spec.

**Changes Made:**
1. Group 0A: Added note "sequential within types.py - T0.1 creates file, T0.2-T0.4 append"
2. T1.2: Added "counter resets to 0 on each call" to match T0.24
3. T5.1: Changed to "Determine exact refs by loading fixtures" instead of hardcoding
4. T0.17: Updated state enum to match spec 1.3.4 exactly
5. T1.5: Added full viewport visibility > role priority > document order ranking

---

## Task Chain Review - Iteration 2 - 2026-02-05T14:00:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [warning] T0.1 center() return type not explicit → Clear from implementation instructions
- [warning] Model availability should be verified → Implementation handles gracefully
- [suggestion] T1.3 could specify method names → Implicit from design
- [suggestion] T3.3 summary format could have test assertion → Example is clear
- [suggestion] T4.2 optional field handling → Implicit omit-when-None behavior

**Summary:** Task breakdown is comprehensive, well-structured, and ready for implementation. All 52 tasks have clear acceptance criteria, proper dependencies, and appropriate time estimates. Fixes address all previously identified concerns. VALIDATION GATE clearly defined with proceed/iterate/stop criteria.

---

# Review History (v2 Design Phase)

## Design Review - Iteration 1 - 2026-02-05T18:00:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision (4 blockers, 7 warnings)

**Blockers:**
- [blocker] [completeness] Screenshot handling undefined - browser_snapshot returns text content (accessibility tree), not screenshot files. No mechanism shown for checkpoint screenshots. (at: Section 2.5, CheckpointHandler)
  Challenge: Where do screenshots come from?
- [blocker] [consistency] SUBTERMINATOR_MODEL environment variable mentioned in spec but not wired up in LLMClient. (at: Section 4.4)
  Challenge: How is the environment variable read and used?
- [blocker] [completeness] _handle_complete_task method has incomplete retry logic - when verification fails, comment says "return error to LLM instead of terminating" but code shows "pass". (at: Section 4.5)
  Challenge: What is the actual retry mechanism?
- [blocker] [consistency] LangChain's AIMessage.tool_calls returns dictionaries with 'name', 'args', 'id' keys (note: 'args' not 'arguments'). TaskRunner code accesses tool_call['arguments']. (at: Section 4.5)
  Challenge: This will cause KeyError at runtime.

**Warnings:**
- [warning] [completeness] SIGINT handling not addressed - no graceful shutdown on Ctrl+C.
- [warning] [completeness] Dry-run mode mentioned in spec but not shown in TaskRunner.
- [warning] [completeness] MCP reconnection logic mentioned in risks but not implemented.
- [warning] [completeness] Auth edge case wiring to checkpoint not shown.
- [warning] [completeness] MCPClient.close() doesn't ensure subprocess termination.
- [warning] [assumptions] CheckpointHandler has no MCPClient reference for screenshots.
- [warning] [consistency] TaskRunner constructor takes CheckpointHandler but creates it internally.

**Changes Made:**
1. Added Section 2.5 (Screenshot Handling) - use browser_take_screenshot tool separately from browser_snapshot
2. Added _resolve_model_name() method to LLMClient with priority: param > env var > default
3. Fixed _handle_complete_task to return dict error (for retry) vs TaskResult (for done)
4. Changed ToolCall.arguments to ToolCall.args throughout to match LangChain format
5. Updated TaskRunner to handle verification failure with loop continuation
6. Added Section 2.6 (SIGINT Handling) with graceful shutdown
7. Added Section 2.7 (Dry-Run Mode) with early exit after first action
8. Added MCPClient.reconnect() method
9. Added MCPClient subprocess termination in close()
10. Updated CheckpointHandler to take MCPClient for screenshots
11. Added _capture_screenshot() method using browser_take_screenshot tool
12. Updated CheckpointHandler class diagram with new attributes/methods

---

## Design Review - Iteration 2 - 2026-02-05T18:25:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Approved

**Verification:** All 4 blockers from iteration 1 correctly addressed:
- ✓ Screenshot handling via browser_take_screenshot tool (Section 2.5)
- ✓ SUBTERMINATOR_MODEL wired up in _resolve_model_name() (Section 4.4)
- ✓ _handle_complete_task returns dict for retry vs TaskResult for done (Section 4.5)
- ✓ LangChain tool_call format uses 'args' throughout (Section 4.1, 4.5)

**Verification:** All 7 warnings from iteration 1 addressed:
- ✓ SIGINT handling (Section 2.6)
- ✓ Dry-run mode (Section 2.7)
- ✓ Reconnection logic (MCPClient.reconnect())
- ✓ Auth edge case wiring in CheckpointHandler.should_checkpoint()
- ✓ Resource cleanup with subprocess termination
- ✓ CheckpointHandler takes MCPClient reference
- ✓ TaskRunner creates CheckpointHandler internally

**Remaining Warnings:**
- [warning] [completeness] if/if instead of if/elif in orchestration loop (benign)
- [warning] [consistency] ToolCall.args vs spec ToolCall.arguments naming
- [warning] [assumptions] browser_take_screenshot format to be validated in POC
- [warning] [completeness] normalize_snapshot() falsy string handling

**Summary:** All blockers resolved. Design is robust and ready for implementation.

---

## Handoff Review - 2026-02-05T18:30:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Verification:**
- ✓ Components defined: MCPClient, LLMClient, TaskRunner, CheckpointHandler, ServiceRegistry
- ✓ Interfaces specified: Full Python signatures with type hints
- ✓ Dependencies identified: mcp SDK, langchain-anthropic, langchain-openai
- ✓ Risks noted: Section 6 covers technical and integration risks

**Issues:**
- [warning] ToolCall field naming diverges from spec (args vs arguments) - noted for plan
- [warning] Reconnection trigger points not fully specified in TaskRunner
- [suggestion] Testing strategy could map to acceptance criteria
- [suggestion] Logging strategy to be defined in plan

**Summary:** Design comprehensive and ready for planning. All major components well-defined with clear interfaces, state machines, and data flows.

---

# Plan Phase Reviews

## Stage 1: Plan Review - Iteration 1 - 2026-02-05T18:45:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision (3 blockers)

**Blockers:**
- [blocker] [assumption] Plan assumes browser_snapshot returns structured dict but Playwright MCP returns markdown-formatted text. normalize_snapshot() will fail to parse.
  Location: P0.3, Design Section 4.7
- [blocker] [dependency] Validation gate doesn't specify HARD BLOCK. If P0.3 fails, P1.x shouldn't start.
  Location: Validation Gate after P0.4
- [blocker] [tdd-order] No explicit task to implement markdown text parser for browser_snapshot output.
  Location: P2.2

**Warnings:**
- [warning] ToolCall.args vs spec.arguments inconsistency needs explicit task to reconcile
- [warning] mcp_orchestrator/services/ creates naming collision with existing services/
- [warning] mcp_orchestrator exceptions may conflict with existing utils/exceptions.py
- [warning] Reconnection failure doesn't specify graceful degradation
- [warning] CLI integration needs review of existing Click structure

**Changes Made:**
1. P0.3 rewritten as "Snapshot Format Discovery & Parser Implementation" with markdown text parser
2. Added explicit NOTE about Playwright MCP output format with example
3. Added browser_take_screenshot validation to P0.3
4. Validation gate now explicit HARD BLOCK with numbered failure handling
5. P0.1 notes ToolCall.args and exception inheritance from SubTerminatorError
6. P1.3 clarified mcp_orchestrator/services/ is separate namespace with justification
7. Reconnection failure now returns TaskResult(reason="mcp_error") gracefully
8. P3.1 notes existing CLI uses Click

---

## Stage 1: Plan Review - Iteration 2 - 2026-02-05T18:55:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Approved

**Verification:** All 3 blockers from iteration 1 addressed:
- ✓ P0.3 now explicitly handles markdown text parsing with line-based extraction
- ✓ Validation gate clearly marked as HARD BLOCK with specific failure handling
- ✓ Parser implementation now explicit deliverable in P0.3

**Remaining Warnings (non-blocking):**
- [warning] Markdown format may vary across Playwright MCP versions
- [warning] P1.3 fixture dependency bundled with format discovery
- [warning] Initial connect() failure handling not addressed
- [warning] P4.2 positioning relative to P2.2

**Summary:** Plan approved for implementation.

---

## Stage 2: Chain Review - 2026-02-05T19:00:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Verification:**
- ✓ All design components covered
- ✓ Clear phase sequencing
- ✓ Explicit validation gate
- ✓ TDD ordering maintained

**Issues:**
- [warning] Plan says Click but existing CLI uses Typer → Updated plan
- [warning] ToolCall.args vs spec.arguments divergence → Documented
- [suggestion] Clarify CLI command strategy (modify vs new command)

**Summary:** Plan well-structured and ready for task breakdown.

**Changes Made (Iteration 2):**
1. P0.1: Clarified OrchestratorError inherits from SubTerminatorError
2. P0.1: Specified existing ConfigurationError will be reused, not duplicated
3. P3.1: Defined CLI strategy using `--auto` flag for backward compatibility
4. Dependency graph updated with explicit P0.3 → P1.3 arrow
5. Added initial connect() failure handling section

---

## Stage 2: Chain Review - Iteration 2 - 2026-02-05T19:15:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Verification:** All 4 issues from iteration 1 addressed:
- ✓ OrchestratorError inheritance explicitly defined (inherits SubTerminatorError)
- ✓ CLI strategy clarified (Typer with `--auto` flag)
- ✓ P0.3 → P1.3 arrow in dependency graph
- ✓ Initial connect() failure handled with TaskResult

**Remaining Suggestions (non-blocking):**
- [warning] ConfigurationError reuse vs create new - minor inheritance inconsistency
- [suggestion] Specify fixture storage location for P1.3 tests
- [suggestion] CLI pattern could be confirmed now (`--service netflix --auto`)

**Summary:** Plan comprehensive and ready for task breakdown.

---

## Handoff Review - 2026-02-05T12:50:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [warning] SnapshotElement vs ElementInfo distinction could be clearer in data types. (at: Section 9.2)
- [warning] PlaywrightBrowser.viewport_size() may need to be added. (at: Section 2.5)
- [suggestion] TOOL_SCHEMAS import relationship unclear. (at: Section 9.4.2, 9.5)
- [suggestion] _format_snapshot helper method not in interface. (at: Section 2.1)

**Summary:** Design comprehensive and ready for implementation planning. All major components defined with clear interfaces, data types, exception handling, and error flows. Minor clarifications would improve but do not block plan phase.

---

# Task Phase Reviews (v2)

## Task Review - Iteration 1 - 2026-02-05T19:30:00Z

**Decision:** Needs Revision (6 blockers)

**Blockers:**
- [blocker] T0.5: Unverified SubTerminatorError existence in utils/exceptions.py
- [blocker] T0.7: Unverified mcp SDK imports - no verification step
- [blocker] T0.10: Missing runnable instructions - script uses call_tool() before implementation
- [blocker] T1.9: Missing function signatures for checkpoint predicates
- [blocker] T2.10: Ambiguous test criteria - missing tool_call context
- [blocker] T3.1: Discovery task without concrete deliverable

**Changes Made:**
1. T0.5: Added explicit check for SubTerminatorError in utils/exceptions.py
2. T0.7: Added mcp SDK import verification step and correct package name (@playwright/mcp@latest)
3. T0.10: Changed to use raw session.call_tool() instead of client.call_tool()
4. T1.9: Added explicit function signatures for checkpoint predicates with both tool AND snapshot
5. T2.10: Added specific test cases with ToolCall context
6. T3.1: Changed from "Review" to "Document" with concrete cli-analysis.md deliverable

---

## Task Review - Iteration 2 - 2026-02-05T19:45:00Z

**Decision:** Approved

**Warnings (non-blocking):**
- [warning] T0.5: Step 1 could directly import SubTerminatorError since grep confirms it exists
- [warning] T0.7: AsyncExitStack management for stdio_client lifecycle not specified
- [warning] T0.9: Exact session close method not specified
- [warning] T1.9: CheckpointPredicate type alias should be in types.py

**Suggestions:**
- T3.1: Consider inlining into T3.2 to reduce task count
- T3.2: Note that -V is already used for --verbose in existing CLI
- T2.7: Specify mock LLM response content for no-action test

**Summary:** All blockers resolved. Task breakdown is comprehensive with 32 tasks across 5 phases and 8 parallel groups. Ready for implementation.

---

## Chain Review - 2026-02-05T19:55:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Verification:**
- ✓ All plan items have corresponding tasks
- ✓ Tasks are appropriately sized (<15 min each)
- ✓ Clear acceptance criteria per task ('Done' field)
- ✓ Dependency graph supports parallel execution

**Warnings (non-blocking):**
- [warning] T0.5 step 3 lists ConfigurationError but step 4 says to import it
- [warning] T0.10 uses private _session attribute (acceptable for debug script)

**Suggestions:**
- Consider formal T0.17 validation gate task
- Verify T1.9 predicate keywords match spec Section 2.5.3

**Summary:** Task breakdown is comprehensive, well-structured, and ready for implementation. 32 tasks with clear dependencies and testable done criteria.

---

## Task Review - Iteration 3 - 2026-02-05T20:15:00Z

**Decision:** Approved

**Changes Made (addressing iteration 2 feedback):**
1. T0.5: Simplified to directly import SubTerminatorError (confirmed to exist)
2. T0.7: Added AsyncExitStack management for stdio_client lifecycle
3. T0.9: Specified exact close method (_exit_stack.aclose())
4. T0.4: Added CheckpointPredicate and SnapshotPredicate type aliases
5. T1.9: Fixed predicate keywords to match spec (removed 'cancel'), import type aliases
6. T1.10: Clarified _mcp usage and added method signature
7. T0.11: Added explicit error messages with diagnostic info
8. T0.12: Clarified fixtures must come from real MCP output
9. T2.7: Added specific mock LLM response and verification details
10. T2.10: Added fixture references for tests
11. Merged T3.1 into T3.2 (reduced task count to 31)
12. T3.2: Note about reusing existing verbose/dry-run flags
13. Updated Parallel Groups table with corrected task numbers

**Warnings (non-blocking):**
- [warning] T0.5: ConfigurationError import could be more explicit
- [warning] T0.7: Subprocess termination after _exit_stack.aclose() is automatic
- [warning] T1.10: CheckpointHandler.__init__ signature not specified

**Summary:** All previous feedback addressed. 31 tasks across 5 phases, 8 parallel groups. Ready for implementation.

---

## Chain Review - Iteration 2 - 2026-02-05T20:25:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Verification:**
- ✓ All plan items have corresponding tasks
- ✓ Tasks are appropriately sized (<15 min each)
- ✓ Clear acceptance criteria per task ('Done' field)
- ✓ Dependency graph supports parallel execution

**Warnings (non-blocking):**
- [warning] T0.10 uses internal _session for discovery (acceptable, script is temporary)
- [warning] T1.9 includes is_payment_page not in spec checkpoint conditions (design addition)

**Suggestions:**
- Align T2.7 prompt message with spec exactly
- Add explicit time estimates to tasks
- Add acceptance criteria to T4.1/T4.2 integration tests

**Summary:** Task breakdown is comprehensive and well-structured for implementation. 31 tasks with clear parallel groups and dependency graphs enable efficient execution.

---

## Task Review - Iteration 4 - 2026-02-05T20:45:00Z

**Decision:** Approved

**Changes Made (addressing iteration 3 feedback):**
1. T0.5: Made ConfigurationError import explicit with code example
2. T0.9: Clarified that _exit_stack.aclose() automatically terminates subprocess
3. T1.10: Added explicit CheckpointHandler.__init__ signature
4. T0.10: Added note about temporary script status and deprecation after T1.1
5. T2.7: Changed prompt message to match spec exactly: "Call a tool or complete_task."
6. T1.9: Documented is_payment_page as intentional design addition
7. T4.1: Added specific test scenarios (happy path, checkpoint, error recovery, max turns)
8. T4.2: Added specific exit code test cases
9. T3.1: Clarified what to check for in existing CLI review

**Suggestions (non-blocking):**
- T0.5: Clarify ConfigurationError re-export vs import distinction
- T3.1: Note -v vs -V verbose flag distinction
- T3.3: Consider exit code conflict with existing CLI code 3
- T2.10: Consider inline mock snapshots for test clarity
- T4.1/T4.2: Specify LLM response mock strategy

**Summary:** All previous feedback addressed. Task breakdown is fully executable.

---

## Chain Review - Iteration 3 (Final) - 2026-02-05T20:55:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Verification:**
- ✓ All plan items have corresponding tasks
- ✓ Tasks are appropriately sized (<15 min each)
- ✓ Clear acceptance criteria per task ('Done' field)
- ✓ Dependency graph supports parallel execution
- ✓ Validation gate enforced between Phase 0 and Phase 1

**Warnings (non-blocking):**
- [warning] T0.10 internal _session access is technical debt (noted as temporary)
- [warning] T0.12 fixture dependency on T0.10 success

**Suggestions:**
- Specify stdin mocking strategy in T1.12
- Add message history structure verification to T2.7
- Add test isolation strategy for T4.1/T4.2

**Summary:** Task breakdown is comprehensive and implementation-ready. 31 tasks with clear acceptance criteria, explicit steps, dependencies, and test specifications.

---

## Task Review - Iteration 5 - 2026-02-05T21:10:00Z

**Decision:** Needs Revision (1 blocker)

**Blocker:**
- [blocker] Plan item P4.2 (LLM Integration Rate-Limited) has no corresponding task

**Changes Made:**
1. Added T4.2 (LLM Provider Integration test) to match plan P4.2
2. Renumbered old T4.2 to T4.3
3. Updated task count to 32
4. Updated parallel groups to show T4.2 can run parallel with T4.1
5. T0.7: Clarified NOT to auto-install mcp package
6. T0.10: Added fallback strategy with expected format
7. T2.5: Clarified turn counter initialization
8. T4.3: Added note about documenting --auto exit codes

---

## Task Review - Iteration 6 (Final) - 2026-02-05T21:20:00Z

**Decision:** Approved

**Suggestions (non-blocking):**
- T0.5: Pre-step to verify exception classes exist
- T2.5: Duplicate step removed
- T3.3: Exit code 5 divergence documented

**Summary:** All plan items now covered. 32 tasks with clear acceptance criteria, dependencies, and test specifications.

---

## Chain Review - Iteration 4 (Final) - 2026-02-05T21:25:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Verification:**
- ✓ All plan items have corresponding tasks (including P4.2)
- ✓ Tasks are appropriately sized (<15 min each)
- ✓ Clear acceptance criteria per task ('Done' field)
- ✓ Dependency graph supports parallel execution
- ✓ 32 tasks across 5 phases

**Warnings (non-blocking):**
- [warning] T0.10 internal _session access documented as temporary
- [warning] T2.5 had duplicate step (fixed)

**Suggestions:**
- T0.4: Consider TYPE_CHECKING pattern for forward reference
- T4.1/T4.3: Note about pytest-xdist for slow tests

**Summary:** Task breakdown is comprehensive and implementation-ready. All plan items covered with 32 tasks.

---
