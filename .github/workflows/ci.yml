name: CI

on:
  push:
    branches: [main, feature/*, fix/*]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: subterminator
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install dependencies
        run: uv sync --all-groups

      - name: Run ruff
        run: uv run ruff check src/

      - name: Run mypy
        run: uv run mypy src/ --ignore-missing-imports

  test:
    name: Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: subterminator
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install dependencies
        run: uv sync --all-groups

      - name: Install Playwright browsers
        run: uv run playwright install chromium --with-deps

      - name: Run tests with coverage
        run: |
          uv run pytest tests/unit/ tests/integration/ -v \
            --cov=src/subterminator \
            --cov-report=xml \
            --cov-fail-under=85

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: subterminator/coverage.xml

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    defaults:
      run:
        working-directory: subterminator
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Build package
        run: uv build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: subterminator/dist/

  claude-litellm:
    name: Claude-LiteLLM
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: claude-litellm
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install dependencies
        run: uv sync

      - name: Run ruff check
        run: uv run ruff check src/ tests/

      - name: Run ruff format check
        run: uv run ruff format --check src/ tests/

      - name: Run unit tests
        run: uv run pytest tests/unit/ -v

  create-pr:
    name: Create PR
    runs-on: ubuntu-latest
    needs: [lint, test, build, claude-litellm]
    if: |
      github.event_name == 'push' &&
      (startsWith(github.ref, 'refs/heads/feature/') ||
       startsWith(github.ref, 'refs/heads/fix/'))
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for existing PR
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          EXISTING=$(gh pr list --head "${{ github.ref_name }}" --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "PR #$EXISTING already exists for this branch"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate PR content
        if: steps.check-pr.outputs.exists == 'false'
        id: pr-content
        run: |
          TITLE=$(git log -1 --pretty=format:'%s')
          echo "title=$TITLE" >> $GITHUB_OUTPUT

          COMMITS=$(git log origin/main..HEAD --pretty=format:'- %s')

          {
            echo "body<<EOF"
            echo "## Changes"
            echo ""
            echo "$COMMITS"
            echo ""
            echo "## Status"
            echo ""
            echo "- Tests: Passed"
            echo "- Coverage: >= 85%"
            echo ""
            echo "---"
            echo "*Auto-generated PR. Review and approve to merge.*"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create PR
        if: steps.check-pr.outputs.exists == 'false'
        id: create-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_URL=$(gh pr create \
            --title "${{ steps.pr-content.outputs.title }}" \
            --body "${{ steps.pr-content.outputs.body }}" \
            --base main)
          echo "url=$PR_URL" >> $GITHUB_OUTPUT
          echo "Created PR: $PR_URL"

      - name: Enable auto-merge
        if: steps.check-pr.outputs.exists == 'false'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if gh pr merge "${{ steps.create-pr.outputs.url }}" \
            --auto \
            --squash \
            --delete-branch; then
            echo "Auto-merge enabled - will merge after approval and checks pass"
          else
            echo "::warning::Auto-merge not enabled. Configure branch protection rules to enable this feature."
            echo "See: Settings → Branches → Add rule for 'main'"
          fi
